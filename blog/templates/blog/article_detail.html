{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ article.title }} - Blog Musical{% endblock %}
{% block content %}
<main class="container my-4 my-md-5">
    <div class="card border-0 shadow-lg">
        <!-- Imagen principal del art√≠culo -->
        {% if article.featured_image %}
        <img src="{{ article.featured_image.url }}" class="card-img-top" alt="{{ article.title }}"
            style="max-height: 650px; object-fit: cover;">
        {% endif %}

        <div class="card-body p-4 p-md-5">
            <!-- Metadata del art√≠culo -->
            <div class="d-flex align-items-center small text-muted mb-2">
                <span>{{ article.user.username }}</span>
                <span class="mx-2">&bull;</span>
                <!-- Muestra la primera categor√≠a si existe, si no, un valor predeterminado -->
                <span>{% if article.category.all %}{{ article.category.first.name }}{% else %}Sin Categor√≠a{% endif %}</span>
            </div>

            <!-- T√≠tulo del art√≠culo -->
            <h1 class="display-5 fw-bold mb-3">
                {{ article.title }}
            </h1>

            <!-- Autor y fecha -->
            <p class="text-muted mb-4">
                por <span class="fw-semibold text-naranja">{{ article.user.username }}</span> | {{ article.created_at | date:"d M, Y" }}
            </p>

            <!-- Contenido del art√≠culo -->
            <article class="fs-5">
                {{ article.content|linebreaks }}
            </article>

            <!-- Botones de interacci√≥n (Likes, Vistas) -->
            <div class="mt-5 d-flex align-items-center flex-wrap">
                <button class="btn btn-link text-decoration-none text-muted d-flex align-items-center me-4 mb-2">
                    <i class="far fa-heart fs-4 me-2"></i>
                    <span class="fw-semibold">{{ article.articlerating_set.count }} Me gusta</span>
                </button>
                <button class="btn btn-link text-decoration-none text-muted d-flex align-items-center me-4 mb-2">
                    <i class="far fa-share-square fs-4 me-2"></i>
                    <span class="fw-semibold">Compartir</span>
                </button>
                <div class="d-flex align-items-center text-muted mb-2">
                    <i class="far fa-eye fs-4 me-2"></i>
                    <span class="fw-semibold">{{ article.articleview_set.count }} Vistas</span>
                </div>

                <!-- Opciones de autor (Editar/Eliminar) -->
                {% if user == article.user %}
                <div class="d-flex align-items-center ms-auto">
                    <a href="{% url 'blog:article_edit' article.slug %}" class="btn btn-outline-warning btn-sm me-2">
                        ‚úèÔ∏è Editar
                    </a>
                    <a href="{% url 'blog:article_delete' article.slug %}" class="btn btn-outline-danger btn-sm">
                        üóëÔ∏è Eliminar
                    </a>
                </div>
                {% endif %}
            </div>

            <hr class="my-5">

            <!-- Categor√≠as y Tags -->
            <div class="mb-3">
                {% if article.category.all %}
                <div class="mb-2">
                    <strong>Categor√≠as:</strong>
                    {% for category in article.category.all %}
                    <span class="badge bg-secondary me-1">{{ category.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                {% if article.tags.all %}
                <div>
                    <strong>Tags:</strong>
                    {% for tag in article.tags.all %}
                    <span class="badge bg-secondary me-1">#{{ tag.name }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

        </div>

        <!-- Secci√≥n de Art√≠culos Similares -->
        <section id="similar-articles-section" class="bg-light p-4 p-md-5 border-top">
            <h2 class="fw-bold mb-4">Art√≠culos Similares</h2>
            <div id="similar-articles-container">
                {% if similar_articles %}
                <div id="similar-articles-carousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for article in similar_articles %}
                        {% if forloop.first %}
                        <div class="carousel-item active">
                        {% else %}
                        <div class="carousel-item">
                        {% endif %}
                            <div class="row">
                                <!-- Aqu√≠ puedes mostrar hasta 3 art√≠culos por slide. El carrusel actual muestra 1 a la vez. -->
                                <div class="col-12">
                                    <div class="card h-100">
                                        {% if article.featured_image %}
                                        <img src="{{ article.featured_image.url }}" class="card-img-top"
                                            alt="{{ article.title }}">
                                        {% else %}
                                        <img src="https://placehold.co/400x300/f39c12/FFFFFF?text={{ article.title|slice:":10" }}" class="card-img-top" alt="{{ article.title }}">
                                        {% endif %}
                                        <div class="card-body">
                                            <h5 class="card-title fw-bold">{{ article.title }}</h5>
                                            <p class="card-text text-muted small">por {{ article.user.username }} |
                                                {{ article.created_at|date:"d M, Y" }}</p>
                                        </div>
                                        <div class="card-footer bg-white border-0 pb-3">
                                            <a href="{% url 'blog:article_detail' article.slug %}"
                                                class="btn btn-sm btn-outline-naranja">Seguir leyendo</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if similar_articles|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#similar-articles-carousel"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#similar-articles-carousel"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <div id="no-similar-articles" class="text-center text-muted p-5">
                    <i class="fas fa-music fa-3x mb-3"></i>
                    <h4 class="fw-bold">Pr√≥ximamente: art√≠culos relacionados</h4>
                    <p>Estamos trabajando para traerte m√°s contenido que te pueda interesar.</p>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Secci√≥n de Comentarios -->
        <section class="bg-white p-4 p-md-5 border-top">
            <h2 class="fw-bold mb-4">Comentarios ({{ comments.count }})</h2>

            <!-- Formulario para nuevo comentario -->
            {% if user.is_authenticated %}
            <form method="post" class="d-flex align-items-start mb-5">
                {% csrf_token %}
                <img src="https://placehold.co/48x48/E5E5E5/000000?text={{ user.username|slice:':1'|upper }}"
                    alt="{{ user.username }} avatar" class="rounded-circle me-3">
                <div class="flex-grow-1">
                    <textarea name="content" id="comment-content" class="form-control" rows="3"
                        placeholder="Escribe tu comentario..." required></textarea>
                    <button type="submit" class="btn btn-naranja mt-2">Publicar</button>
                </div>
            </form>
            {% else %}
            <div class="alert alert-info">
                <a href="{% url 'user_auth:login' %}">Inicia sesi√≥n</a> para poder comentar en este art√≠culo.
            </div>
            {% endif %}

            <!-- Lista de comentarios -->
            <div class="d-grid gap-4">
                {% if comments %}
                {% for comment in comments %}
                <div class="d-flex align-items-start">
                    <img src="https://placehold.co/48x48/{{ '0123456789abcdef'|random }}{{ '0123456789abcdef'|random }}D25C2A/FFFFFF?text={{ comment.user.username|slice:':1'|upper }}"
                        alt="Avatar de {{ comment.user.username }}" class="rounded-circle me-3">
                    <div class="flex-grow-1 bg-light p-3 rounded border">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <p class="fw-bold mb-0">{{ comment.user.username }}</p>
                            {% if user == comment.user %}
                            <!-- No existe una URL de delete para comentarios, se deja como placeholder -->
                            <button class="btn btn-outline-danger btn-sm">
                                üóëÔ∏è
                            </button>
                            {% endif %}
                        </div>
                        <p class="mb-0 text-muted">{{ comment.content|linebreaks }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted p-4">
                    <p class="mb-0">
                        No hay comentarios a√∫n. ¬°S√© el primero en comentar!
                    </p>
                </div>
                {% endif %}
            </div>
        </section>

    </div>

    <!-- Bot√≥n volver -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'blog:article_list' %}" class="btn btn-secondary">
                ‚Üê Volver a la lista
            </a>
        </div>
    </div>
</main>

{% endblock %}
